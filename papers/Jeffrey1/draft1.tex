\documentclass{article}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{enumerate}
\usepackage[bookmarks=true]{hyperref}
\usepackage{bookmark}
\usepackage{graphicx}

\input{../../physics_common}
\title{Importance Sampling}
\author{Xie Xiaolei}
\date{\today}

\begin{document}
\maketitle
\section{Introduction}
We consider the model
\begin{eqnarray*}
V_n &=& A_n V_{n-1} \\
V_0 &=& x_0 \in \mathbb S^{d-1}\\
\end{eqnarray*}
Use the following notations
\begin{eqnarray*}
X_n &=& \frac{V_n}{\|V_n\|} \\
S_n &=& \log \|A_n \cdots A_1 x_0\| \\
\xi_n &=& S_n - S_{n-1} = \log\frac{\|A_n \cdots A_1 x_0\|}{\|A_{n-1}
  \cdots A_1 x_0\|} \\
&=& \log\left\| A_n \frac{A_{n-1} \cdots A_1 x_0}{\|A_{n-1} \cdots A_1
    x_0\|} \right\|\\
&=& \log \|A_n X_{n-1}\|
\end{eqnarray*}
The pair $(X_n, S_n)$ is a Markov additive process with transition
kernel $P$. Assume conditions (M) and (A) of Kesten \cite{Kesten1973}:
\begin{enumerate}
\item The top Lyapunov exponent is negative, i.e.
  \begin{equation}
    \label{eq:neg_top_Lyapunov}
    \inf_{n \geq 1} \E \log \|A_n \cdots A_1\| < 0    
  \end{equation}
\item $\exists \xi > 0$ such that $\lambda(\xi) = 1$, where
  $$
  \lambda(\xi) := \inf_{n \geq 1} (\E \|A_n \cdots A_1\|^\xi)^{1/n}
  $$
\item $\exists \epsilon > 1$ such that $\E[\|A\|^{\xi\epsilon}] <
  \infty$, $\E |B|^{\xi \epsilon} < \infty$

\end{enumerate}

\section{Consistency}\label{sec:consistency}
By the law of large numbers
\begin{eqnarray*}
  && \P(|V| > u) \\
  &=& \lim_{n \to \infty} {1 \over n} \sum_{i=0}^n \1{|V_i| > u}
\end{eqnarray*}
Define
\[
R_n := \inf\{0 \leq i \leq n: V_i \in \mathcal C\}
\]
and
\[
K_i := \inf\{k \geq 1: k > K_{i-1}, V_k \in \mathcal C, K_0 = 0\}
\]
Then one can write
\begin{eqnarray*}
  && \lim_{n \to \infty} {1 \over n} \sum_{i=1}^n \1{|V_i| > u} \\
  &=& \lim_{n \to \infty} {1 \over n} \left[
    \sum_{i=0}^{K_{R_n}-1} \1{|V_i| > u} + \sum_{i=K_{R_n}}^n \1{|V_i| > u}
\right]
\end{eqnarray*}
For the 2nd term, by a Borel-Cantelli argument, it maybe shown
\[
\lim_{n \to \infty} {1 \over n}\sum_{i=K_{R_n}}^n \1{|V_i| > u} = 0
\]
For the 1st term,
\begin{eqnarray*}
&& \lim_{n \to \infty} {1 \over n} \sum_{i=0}^{K_{R_n}-1} \1{|V_i| >
  u}  \\
&=& \lim_{n \to \infty} {R_n \over n} {1 \over R_n} \sum_{i=1}^{R_n}
\sum_{j=K_{i-1}}^{K_i-1}\1{|V_i| > u} \\
&=& \pi(\mathcal C) \E_\gamma N_u
\end{eqnarray*}
where the law of large numbers of Markov chains has been used to reach
the last line. In addition, it is assumed
\begin{eqnarray*}
  V_{K_i} &\sim& \gamma \; \forall i \geq 0 \\
  \gamma(E) &=& \pi(E)/\pi(\mathcal C)\; \forall E \in \mathcal
  B(\mathcal C)
\end{eqnarray*}
Define
\begin{eqnarray*}
  T_u &=& \inf\{n \geq 1: |V_n| > u\} \\
  \tau &\overset{d}{=}& K_i - K_{i-1} \\
  N_u &:=& \sum_{i=0}^{\tau-1} \1{|V_i| > u}  \\
\end{eqnarray*}
Then $\E_\gamma N_u$ may be evaluated as
\begin{eqnarray*}
  && \E_\gamma N_u \\
  &=& \E_\gamma N_u \1{T_u < \tau} \\
  &=& \int_{\mathds S^{d-1}} \int_{\mathds R} \cdots \int_{\mathds
    S^{d-1}} \int_{\mathds R} N_u \1{T_u < \tau} \times \\
  && \prod_{i=1}^{T_u} e^{-\xi(s_i - s_{i-1}) + \lambda(\xi)}
  {r(x_{i-1}; \xi) \over r(x_{i}; \xi)}P_\xi(x_{i-1}, dx_i \times ds_i) \times \\
  && \prod_{i=T_u+1}^{\tau-1} P(x_{i-1}, dx_i \times d s_i) \\
  &=& \E_{\mathcal D} \left[
    N_u \1{T_u < \tau} e^{-\xi S_{T_u}} {r(x_0; \xi)
      \over r(x_{T_u}; \xi)}
  \right]
\end{eqnarray*}
where
\[
P_\xi(x_{i-1}, dx_i \times ds_i) = e^{\xi(s_i - s_{i-1}) -
  \lambda(\xi)} {r(x_i; \xi) \over r(x_{i-1}; \xi)} P(x_{i-1}, dx_i
\times ds_i)
\]
is the $\xi$-shifted transition kernel of the {\it Markov Additive
  process} $(X_n, S_n)$. $\xi$ is chosen such that 
\[
\lambda(\xi) = \lim_{n \to \infty} \log \left(
\E \|A_n \cdots A_1\|^\xi
\right)^{1/n} = 0
\]
$\E_{\mathcal D}$ denotes expectation taken with respect to the dual
measure defined as
\[
P_{\mathcal D} (x_i, dx_{i+1} \times ds) = \left\{
  \begin{array}{ll}
    P_\xi (x_i, dx_{i+1} \times ds) & \text{ if } i < T_u \\
    P(x_i, dx_{i+1} \times ds) & \text{ if } i \geq T_u \\
  \end{array}
\right.
\]
Because the top Lyapunov exponent is negative, it follows from a lemma
in Kesten \cite{Kesten1973} that there is a $s > 0$ such that
$\lambda(s) < 0$.

Thus we have obtained a consistent estimator
$\pi(\mathcal C)\mathcal E_u$ for $\P(|V| > u)$:
\begin{eqnarray*}
\P(|V| > u) &=& \pi(\mathcal C) \E_{\mathcal D} \mathcal E_u \\
&=& \pi(\mathcal C) \E_{\mathcal D} \left[
  N_u \1{T_u < \tau} e^{-\xi S_{T_u}} {r(x_0; \xi)
    \over r(x_{T_u}; \xi)}
\right]
\end{eqnarray*}

\section{Efficiency}\label{sec:efficiency}
\begin{lemma}
  Let $\beta \in \mathbb R$ satisfy
  \begin{enumerate}
  \item
    \begin{equation}
      \label{eq:drift_cond1}
      \E \|A\|^\beta < \infty      
    \end{equation}
  \item 
    \begin{equation}
      \label{eq:drift_cond2}
    \inf_{\alpha > 0} {\E \|A\|^{\alpha + \beta}
      \over 
      \E \|A\|^{\beta}
    } < 1
    \end{equation}
  \end{enumerate}
  then $\forall \alpha > 0$ such that $\frac{\E\|A\|^{\beta +
      \alpha}}{\E\|A\|^\beta} < 1$ , we have
  \begin{equation}
    \label{eq:drift}
    \E_\beta \left[\left.
        |V_n|^\alpha r_\beta(|\tilde V_n|; \alpha) \I{C^\complement}(V_{n-1}) \right|
      \mathcal F_{n-1} \right] \leq |V_{n-1}|^\alpha r_\beta(|\tilde
    V_{n-1}|; \alpha) \I{C^\complement}(V_{n-1})
  \end{equation}
  where $r_\beta(\cdot; \alpha)$ is the unique right eigen function of the
  operator
  \[
  P_{\alpha, \beta} f(x) = \int |\hat a x|^\alpha f\left(
    {\hat a x \over |\hat a x|}
  \right) d\mu_A^\beta(\hat a)
  \]
  where the $\beta$-shifted measure $\mu_A^\beta$ satisfies
  \[
  d\mu_A^\beta(\hat a) = {\|\hat a\|^\beta d\mu_A(\hat a) \over \E\|A\|^\beta}
  \]
\end{lemma}

\begin{proof}
  Conditions \eqref{eq:drift_cond1} and \eqref{eq:drift_cond2} imply $\E_\beta
  \|A\|^\alpha < \infty$. Then, using the results of Buraczewski and
  Collamore et al \cite{BCDZ2014}, one may conclude that an eigen
  function $r_\beta(\cdot; \alpha)$ as well as an eigen measure
  $l_\beta(\cdot; \alpha)$ exists under the $\beta$-shifted
  measure. Thus, by defining the adjoint operator under  the shifted
  measure, the right eigen function $r_\beta(x; \alpha)$ can be represented as
  \[
  r_\beta(x; \alpha) = c \int_{S_+^{d-1}} \inn{x, y}^\alpha
  dl^*_{\beta}(x; \alpha)
  \]
Now, to prove \eqref{eq:drift}, consider
  \begin{eqnarray*}
    && \E_\beta \left[ |V_n|^\alpha r_\beta(\tilde V_n; \alpha) | \mathcal F_{n-1} \right]
    \\
    &=& \E_\beta\left[\int_{S_+^{d-1}} \inn{V_n, y}^\alpha dl^*_{\beta}(y; \alpha)|
      \mathcal F_{n-1} \right]
    \\
    &=& \E_\beta\left[\int_{S_+^{d-1}} (\inn{A_n V_{n-1}, y} + \inn{B_n,
        y})^\alpha dl^*_{\beta}(y; \alpha) | \mathcal F_{n-1} \right]
  \end{eqnarray*}
  \begin{enumerate}
  \item if $\alpha < 1$, by subadditivity we have
    \begin{eqnarray*}
      &&\E_\beta\left[\int_{S_+^{d-1}} (\inn{A_n V_{n-1}, y} + \inn{B_n,
          y})^\alpha dl^*_{\beta}(y; \alpha) | \mathcal F_{n-1} \right]\\
      &\leq& \E_\beta\left[\int_{S_+^{d-1}} \inn{A_n V_{n-1}, y}^\alpha
        dl^*_{\beta}(y; \alpha) | \mathcal F_{n-1} \right]
      + \E_\beta\left[\int_{S_+^{d-1}} \inn{B_n, y}^\alpha dl^*_{\beta}(y; \alpha) |
        \mathcal F_{n-1} \right] \\
      &=& \E_\beta\left[|V_{n-1}|^\alpha |A_n \tilde V_{n-1}|^\alpha\int_{S_+^{d-1}}
        \inn{{A_n V_{n-1} \over |A_n V_{n-1}|}, y}^\alpha
        dl^*_{\beta}(y; \alpha) | \mathcal F_{n-1} \right] \\
      && + \E_\beta\left[\int_{S_+^{d-1}} \inn{B_n, y}^\alpha dl^*_{\beta}(y; \alpha) |
        \mathcal F_{n-1} \right] \\
      &=& |V_{n-1}|^\alpha \left\{
        (P_{\alpha, \beta} r_{\beta})(\tilde V_{n-1}; \alpha) +
        {1 \over |V_{n-1}|^\alpha} \E_\beta |B_n|^\alpha r_\beta(\tilde
        B_n; \alpha) \right\} \\
      &=& |V_{n-1}|^\alpha r_\beta(\tilde V_{n-1}; \alpha)\left\{
        \lambda_\beta(\alpha) +
        {1 \over |V_{n-1}|^\alpha r_\beta(\tilde V_{n-1}; \alpha)} \E_\beta
        |B_n|^\alpha r_\beta(\tilde B_n; \alpha) \right\} \\
    \end{eqnarray*}
    By assumption, $\E_\beta|B_n|^\alpha < \infty$; and
    $r_\beta(\tilde B_n; \alpha) < \infty$, $r_\beta(\tilde V_{n-1};
    \alpha) < \infty$ according to Buraczewski and Collamore \cite{BCDZ2014}.
    Hence the infimum of the expression in the curly bracket over all $n \geq 1$ is
    $\lambda_\beta(\alpha) < 1$. Therefore, when $|V_{n-1}|$ is
    sufficiently large, $\rho_{\beta}(\alpha)$ an be chosen such that
    \begin{eqnarray*}
      \rho_{\beta}(\alpha) &<& 1 \\
      \E_\beta \left[ |V_n|^\alpha r_\beta(\tilde V_n; \alpha)  \I{C^\complement}(V_{n-1})
        | \mathcal F_{n-1} \right] &\leq&
      \rho_\beta(\alpha) |V_{n-1}|^\alpha r_\beta(\tilde V_{n-1}; \alpha) \I{C^\complement}(V_{n-1})
    \end{eqnarray*}
    where $C^\complement$ denotes the complement of the set $C$:
    \[
    C = \left\{
      v: |v| \leq M, M = \left[
        \E_\beta (|B|^\alpha r_\beta(\tilde B; \alpha)) 
        \over
        [1 - \lambda(\alpha)] r_\beta(\tilde v; \alpha)
      \right]^{1/\alpha}
    \right\}
    \]
  \end{enumerate}    
% that there exist a unique
%   probability measure $l_\alpha$ on $\mathbb S_+^{d-1}$ and a unique
%   and strictly positive function $r_\alpha \in \mathscr C_b(\mathbb
%   S_+^{d-1})$ such that
%   \begin{eqnarray*}
%     P_\alpha r(x; \alpha) &=& \lambda(\alpha) r(x; \alpha) \\
%     l_\alpha P_\alpha (S) &=& \lambda(\alpha) l_\alpha(S) \\
%     \int_{S_+^{d-1}} r(x; \alpha) l_\alpha(dx) &=& 1
%   \end{eqnarray*}
\end{proof}
\begin{remark}
  Iterating \eqref{eq:drift} yields
  \[
  \E_\beta \left[
    |V_n|^\alpha r_\beta(|\tilde V_n|; \alpha) \prod_{i=1}^{n-1}\I{C^\complement}(V_i)\right]
  \leq \rho_\beta(\alpha)^{n-1} |V_1|^\alpha r_\beta(|\tilde V_1|; \alpha) \I{C^\complement}(V_1)
  \]
  Then it follows
  \[
  \E_\beta \left[
    |V_n|^\alpha r_\beta(|\tilde V_n|; \alpha) \prod_{i=1}^{n}\I{C^\complement}(V_i)\right]
  \leq \rho_\beta(\alpha)^{n-1} |V_1|^\alpha r_\beta(|\tilde V_1|; \alpha) \I{C^\complement}(V_1)
  \]
  But $\prod_{i=1}^{n}\I{C^\complement}(V_i)$ implies $\tau > n$, and in this
  case $|V_n| > M$, where
  \[
  M = \left[
    \E_\beta (|B|^\alpha r_\beta(\tilde B; \alpha)) 
    \over
    (1 - \lambda(\alpha)) r_\beta(\tilde v; \alpha)
  \right]^{1/\alpha}
  \]
  Hence
  \begin{eqnarray}
    \E_\beta \left[
      M^\alpha \inf_{|\tilde V_n|} r_\beta(|\tilde V_n|; \alpha) \1{\tau > n}\right]
    &\leq& \rho_\beta(\alpha)^{n-1} |V_1|^\alpha r_\beta(|\tilde V_1|; \alpha) \I{C^\complement}(V_1) \nonumber \\
    \P_\beta(\tau > n) &\leq& K \rho_\beta(\alpha)^{n-1} \label{eq:ret_time}
  \end{eqnarray}
  for some constant $K$.
\end{remark}


%% \subsection{The Drift Condition}
%%% What follows is the proof in the 1D case.
% Consider
% \begin{eqnarray*}
%   && \int_E |y|^\alpha P_\beta(v, dy)  \\
%   &=& \int_E |A_n v + B_n|^\alpha \P_\beta\left(V_n \in [y, y +dy) |
%   V_{n-1} = v\right) \\
% &=& \int_{R^3} |A_n v + B_n|^\alpha d\mu_\beta(\log A_n, B_n, D_n) \\
% &=& \E_\beta |A_n v + B_n|^\alpha
% \end{eqnarray*}
% \begin{enumerate}[(i)]
% \item if $\alpha < 1$, $|\cdot|^\alpha$ is a concave and hence
%   subadditive function. We have
%   \begin{eqnarray*}
%     && \E_\beta |A_n v + B_n|^\alpha    \\
%     &\leq& |v|^{\alpha}\E_\beta|A_n|^\alpha + \E_\beta|B_n|^\alpha \\
%     &\leq& |v|^{\alpha}\left(
%       \E_\beta|A_n|^\alpha + |v|^{-\alpha}\E_\beta|B_n|^\alpha
%     \right)\\
%   \end{eqnarray*}
%   Clearly
%   \begin{eqnarray*}
%     \inf_{v} \left(
%       \E_\beta|A_n|^\alpha + |v|^{-\alpha}\E_\beta|B_n|^\alpha
%     \right) = \E_\beta|A_n|^\alpha
%   \end{eqnarray*}
%   Therefore, if there exists an $\alpha > 0$ such that
%   $\E_\beta|A_n|^\alpha < 1$, $|v|$ can be chosen sufficiently large
%   so that $\E_\beta|A_n|^\alpha + |v|^{-\alpha}\E_\beta|B_n|^\alpha <
%   1$. By definition,
%   \begin{eqnarray*}
%     && \E_\beta |A_n|^\alpha \\
%     &=& \int_{R^3} |A_n|^{\alpha + \beta} d\mu(\log A_n, B_n, D_n)
%     \times \\
%     && \left[
%       \int_{R^3} |A_n|^{\beta} d\mu(\log A_n, B_n, D_n)
%     \right]^{-1} \\
%     &=& {\E |A_n|^{\alpha + \beta} \over \E |A_n|^{\beta}}
%   \end{eqnarray*}
%   Since $\E|A_n|^{\zeta}$ is convex and by
%   assumption, $\E|A_n|^{\xi} =\E|A_n|^0= 1$, it immediately follows
% \[
% \exists s \in (0, \xi), \E |A_n|^s = \inf_{\zeta \in (0, \xi)} \E
% |A_n|^\zeta < 1
% \]
% Thus, for any given $\alpha \in (0, \xi)$, one can always find
% $\beta\in [0, \xi-\alpha]$ such that $\E_\beta |A_n|^\alpha = {\E
%   |A_n|^{\alpha + \beta} \over \E |A_n|^{\beta}} < 1$. Once $\beta$
% has been chosen accordingly, one can choose $v \notin (-M_\beta,
% M_\beta)$ so that $\E_\beta|A_n|^\alpha +
% |v|^{-\alpha}\E_\beta|B_n|^\alpha < 1$. Here
% \[
% M_\beta = \left({\E_\beta |B_n|^\alpha \over 1 - \E_\beta
%     |A_n|^\alpha}\right)^{1/\alpha}
% \]

% \item if $\alpha \geq 1$, by Minkowskii inequality,
%   \begin{eqnarray*}
%     && \E_\beta |A_n v + B_n|^\alpha \\
%     &\leq& |v|^\alpha\left[
%       (\E_\beta|A_n|^\alpha)^{1/\alpha} + {(\E_\beta
%         |A_n|^\alpha)^{1/\alpha} \over |v|}
%     \right]^\alpha
%   \end{eqnarray*}
%   The same arguments as in the $\alpha < 1$ case apply. But in this
%   case we have
%   \[
%   M_\beta = \left[{
%     (\E_\beta |B_n|^\alpha)^{1/\alpha}
%     \over
%     1 - (\E_\beta|A_n|^\alpha)^{1/\alpha}
%   }\right]^{1/\alpha}
% \]


% In this section we prove
% \[
% \E \left[ |V_n|^\alpha r_{\xi, \alpha}(\tilde V_n) | \mathcal F_{n-1} \right] \leq
% \rho |V_{n-1}|^\alpha r_{\xi,\alpha}(\tilde V_{n-1})
% \]
% for some $\rho < 1$.
% where 
% \begin{proof}
%   \begin{eqnarray*}
%     && \E \left[ |V_n|^\alpha r(\tilde V_n; \alpha) | \mathcal F_{n-1} \right]
%     \\
%     &=& \E\left[\int_{S_+^{d-1}} \inn{V_n, y}^\alpha dl^*_\alpha(y)|
%       \mathcal F_{n-1} \right]
%     \\
%     &=& \E\left[\int_{S_+^{d-1}} (\inn{A_n V_{n-1}, y} + \inn{B_n,
%         y})^\alpha dl^*_\alpha(y) | \mathcal F_{n-1} \right]
%   \end{eqnarray*}
%   \begin{enumerate}[(i)]
%   \item if $\alpha < 1$, by subadditivity we have
%     \begin{eqnarray*}
%       &&\E\left[\int_{S_+^{d-1}} (\inn{A_n V_{n-1}, y} + \inn{B_n,
%           y})^\alpha dl^*_\alpha(y) | \mathcal F_{n-1} \right]\\
%       &\leq& \E\left[\int_{S_+^{d-1}} \inn{A_n V_{n-1}, y}^\alpha
%         dl^*_\alpha(y) | \mathcal F_{n-1} \right]
%       + \E\left[\int_{S_+^{d-1}} \inn{B_n, y}^\alpha dl^*_\alpha(y) |
%         \mathcal F_{n-1} \right] \\
%       &=& \E\left[|V_{n-1}|^\alpha |A_n \tilde V_{n-1}|^\alpha\int_{S_+^{d-1}}
%         \inn{{A_n V_{n-1} \over |A_n V_{n-1}|}, y}^\alpha
%         dl^*_\alpha(y) | \mathcal F_{n-1} \right] \\
%       && + \E\left[\int_{S_+^{d-1}} \inn{B_n, y}^\alpha dl^*_\alpha(y) |
%         \mathcal F_{n-1} \right] \\
%       &=& |V_{n-1}|^\alpha \left\{
%         (P_\alpha r_\alpha)(\tilde V_{n-1}) +
%         {1 \over |V_{n-1}|^\alpha} \E |B_n|^\alpha r(\tilde
%         B_n; \alpha) \right\} \\
%       &=& |V_{n-1}|^\alpha r(\tilde V_{n-1}; \alpha)\left\{
%         \lambda(\alpha) +
%         {1 \over |V_{n-1}|^\alpha r(\tilde V_{n-1}; \alpha)} \E
%         |B_n|^\alpha r(\tilde B_n; \alpha) \right\} \\
%     \end{eqnarray*}
%     Clearly $\E\left[|B_n|^\alpha r(\tilde B_n; \alpha)\right] <
%     \infty$. Hence the infimum of the expression in the curly bracket
%     over all $n \geq 1$ is $\lambda(\alpha) < 1$. Therefore, when
%     $|V_{n-1}|$ is sufficiently large, we have
%     \[
%     \E \left[ |V_n|^\alpha r(\tilde V_n; \alpha) | \mathcal F_{n-1} \right] \leq
%     \rho |V_{n-1}|^\alpha r(\tilde V_{n-1}; \alpha)
%     \]
%   \end{enumerate}    
% \end{proof}

\begin{theorem}
  The estimator $\mathcal E_u$ has bounded relative error, i.e.
  \begin{equation*}
    \limsup_{u \to \infty} {\var(\mathcal E_u) \over [\P(|V| > u)]^2} < \infty
  \end{equation*}
\end{theorem}
\begin{proof}
  The claim is equivalent to
  \[
  \limsup_{u \to \infty} {\E_D \mathcal E_u^2 \over [\P(|V| > u)]^2} < \infty
  \]
  By Kesten's theorem \cite{Kesten1973}, $\P(|V| > u) \sim C
  u^{-\xi}$. Hence, to prove the claim, one needs to check
  $u^{2\xi}\E_D \mathcal E_u^2 < \infty$, i.e.
  \[
  f(\xi) = \limsup_{u \to \infty} \E_D  \left[u^{2\xi}
    N_u^2 \1{T_u < \tau} e^{-2\xi S_{T_u}} {r^2(x_0; \xi)
      \over r^2(x_{T_u}; \xi)}\right]
  < \infty
  \]
  In the rest of the proof, we write $c, c_1, c_2$ for constants whose values
  have no importance and depend on the context.
  \begin{enumerate}
  \item We first consider the case $\lambda(-\xi\epsilon) <
    \infty$. Using the fact $|V_{T_u}| > u$  we obtain
    \begin{eqnarray*}
      f(\xi) &\leq& \limsup_{u \to \infty} \E_D \left[
        N_u^2  \left|
          \frac{
            \sum_{n=0}^{T_u} A_{T_u} \cdots A_{n+1} B_n 
          }{
            |A_{T_u} \cdots A_1 V_0|
          }
        \right|^{2 \xi}
        \frac{
          r(X_0; \xi)^2
        }{
          r(X_{T_u}; \xi)^2
        } \1{T_u < \tau}
      \right] \\
    \end{eqnarray*}
    where $r, s$ are chosen such that $1/r + 1/s = 1$ and $s \in (1,
    \frac{\epsilon + 1}{2})$. With such a choice $\E \|A\|^{\xi(2s -
      1)} < \E \|A\|^{\xi \epsilon} < \infty$.


    Then H\"older's
    inequality gives
    \begin{eqnarray*}
      f(\xi) &\leq& \limsup_{u \to \infty}
      \left(\E_D N_u^{2r} \1{T_u < \tau}\right)^{1/r}
      \left(\E_D \left|
          \frac{
            \sum_{n=0}^{T_u} A_{T_u} \cdots A_{n+1} B_n 
          }{
            |A_{T_u} \cdots A_1 V_0|
          }
        \right|^{2 s \xi} \1{T_u < \tau}
      \right)^{1/s} \\
      &\leq& c \limsup_{u \to \infty} f_1(u) f_2(u, \xi)
    \end{eqnarray*}
    \begin{enumerate}
    \item First of all, we prove $f_2(u,\xi) < \infty$. Minkowski's
      inequality yields
      \begin{eqnarray*}
        f_2(u, \xi)^{1/2\xi} &\leq& \sum_{n=0}^\infty \left(\E_D \left[
            \frac{
              |A_{T_u} \cdots A_{n+1} B_n |^{2s\xi}
            }{
              |A_{T_u} \cdots A_1 V_0|^{2s\xi}
            } \1{n \leq T_u < \tau}
          \right]\right)^{1/2s\xi} \\
        &=& \sum_{n=0}^\infty \left(\E \left[
            \frac{
              |A_{T_u} \cdots A_{n+1} B_n |^{2s\xi}
            }{
              |A_{T_u} \cdots A_1 X_0|^{\xi(2s - 1)}
            }
            \frac{
              r_{\xi}(X_{T_u})
            }{
              r_{\xi}(X_{0})
            }
            {1 \over |V_0|^{2s\xi}}\1{n \leq T_u < \tau}
          \right]\right)^{1/2s\xi} \\
        &\leq& c \sum_{n=0}^\infty
        \left(\E_{-\xi(2s - 1)} \left[
            |A_{T_u} \cdots A_{n+1} B_n |^{2s\xi}
            \lambda(-\xi(2s - 1))^{T_u}
            \1{n \leq T_u < \tau}
          \right]\right)^{1/2s\xi} \\
        &=& c \sum_{n=0}^\infty [\E_{-\xi(2s - 1)}
        f_{2,n}(u,\xi)]^{1/2s\xi}
      \end{eqnarray*}
      \begin{enumerate}
      \item if $s > 1/2\xi$, $(\cdot)^{1/2s\xi}$ is concave and
        subadditive. We have
        \begin{eqnarray*}
          && [\E_{-\xi(2s - 1)} f_{2,n}(u,\xi)]^{1/2s\xi} \\
          &=& \left[
              \sum_{k=n}^\infty
              \E_{-\xi(2s - 1)}\left(
              \|A_k \cdots A_{n+1}\|^{2s\xi}
              \right)
              \E_{-\xi(2s - 1)} |B_n|^{2s\xi} \times \right.\\
          && \left. \lambda(-\xi(2s - 1))^k \1{\tau > T_u}
             \P_{-\xi(2s - 1)}(T_u \geq k) \right]^{1/2s\xi}\\
          &\leq& \sum_{k=n}^\infty
                 \left[\E_{-\xi(2s - 1)}
                 \|A_k \cdots A_{n+1}\|^{2s\xi}
                 \right]^{1/2s\xi}
                 \left[\E_{-\xi(2s - 1)} |B_n|^{2s\xi}\right]^{1/2s\xi} \times \\
          && \lambda(-\xi(2s - 1))^{k/2s\xi} \1{\tau > T_u}
             \left[ \P_{-\xi(2s - 1)}(T_u \geq k) \right]^{1/2s\xi}
        \end{eqnarray*}
        Obviously $\1{\tau > T_u} \P_{-\xi(2s - 1)}(T_u \geq k) \leq
        \P_{-\xi(2s - 1)}(\tau > k-1)$. Moreover
        \begin{eqnarray*}
          && \E_{-\xi(2s - 1)} |B_n|^{2s\xi} = \frac{
             \E |B_n|^{\xi}
             } {
             \E |B_n|^{-\xi(2s - 1)}
             } \leq \E |B_n|^{\xi} \E |B_n|^{\xi(2s - 1)}
             < \E |B_n|^{\xi} \E |B|^{\xi \epsilon} < \infty
        \end{eqnarray*}
        Furthermore, as shown by Buraczewski, Damek
        and Mikosch \cite{BuraczewskiDamekMikosch2015},
        \[
        \lim_{k \to \infty}
        \left[ \E_{-\xi(2s - 1)}\left(
            \|A_k \cdots A_{n+1}\|^{2s\xi}|T_u = k
          \right) \right]^{1/(k-n)} = \lambda_{-\xi(2s - 1)}(2s\xi)
        \]
        % and
        % \[
        % \inf_{k \geq n+1}
        % \left(
        %   \E_{-\xi(2s - 1)}\|A_k \cdots A_{n+1}\|^{2s\xi}
        % \right)^{1/(k - n)} = \lambda_{-\xi(2s - 1)}(2s\xi)
        % \]
        Hence $\forall a > 1$, $\exists N \geq 1$ such that $\forall k
        \geq n + N$,
        \[
        (\E_{-\xi(2s - 1)}\|A_{n+N} \cdots A_{n+1}\|^{2s\xi})^{1/N} <
        a \lambda_{-\xi(2s - 1)}(2s\xi)
        \]
        Meanwhile, for $k \in \{n+1, \dots, n+N-1\}$, due to the
        independence of $A_{n+1}, A_{n+2}, \dots, A_k$ we have
        \begin{eqnarray*}
          && \E_{-\xi(2s - 1)} \|A_k \dots A_{n+1}\|^{2s\xi} \\
          &\leq& [\E_{-\xi(2s - 1)} \|A_1\|^{2s\xi}]^{k-n} \\
          &=& \left[{1 \over \E \|A_1\|^{-\xi(2s - 1)}}\right]^{k-n} \\
        \end{eqnarray*}
        By Jensen's inequality,
        \[
        \E \|A_1\|^{-\xi(2s - 1)}
        \geq {1 \over \E\|A_1\|^{\xi(2s - 1)}}
        \geq {1 \over \E\|A_1\|^{\xi\epsilon'}}
        \]
        Hence
        \[
        \E_{-\xi(2s - 1)} \|A_k \dots A_{n+1}\|^{2s\xi} \leq
        \E \|A_1\|^{\xi \epsilon' (k-n)} < \infty      
        \]
        Now we can write
        \begin{eqnarray*}
          && c \sum_{n=0}^\infty [\E_{-\xi(2s - 1)} f_{2,n}(u,\xi)]^{1/2s\xi} \\
          &\leq& c \sum_{n=0}^\infty \left\{
                 c_1 \sum_{k=n}^{n+N-1} \lambda(-\xi(2s - 1))^{k/2s\xi} [\P_{-\xi(2s -
                 1)}(\tau > k-1)]^{1/2s\xi} \right.\\
          && + \sum_{k=n+N}^\infty [a \lambda_{-\xi(2s - 1)}(2s\xi)]^{(k-n)/2s\xi}
             \lambda(-\xi(2s - 1))^{k/2s\xi} \times \\
          && \left.[\P_{-\xi(2s - 1)}(\tau > k-1)]^{1/2s\xi}
             \right\}
        \end{eqnarray*}
        Applying \eqref{eq:ret_time} with $\beta = -\xi(2s - 1)$ gives
        \[
        \P_{-\xi(2s - 1)}(\tau > k-1) \leq K \lambda_{-\xi(2s - 1)}(\alpha)^{k-2}
        \]
        where $\alpha > 0$ is chosen such that $\lambda_{-\xi(2s -
          1)}(\alpha) < 1$.
        % This is always possible because
        % $\lambda_{-\xi(2s - 1)}(\alpha) = \lambda(-\xi(2s - 1) + \alpha) /
        % \lambda(-\xi(2s - 1))$, and ${d \lambda(-\xi(2s - 1) +
        % \alpha) \over d\alpha} < 0$.
        Let $p = \lambda(\alpha - \xi(2s - 1))^{1/2s\xi} < 1$, and $q =
        \lambda(-\xi(2s - 1))^{1/2s\xi} > 1$. We have
        \begin{eqnarray*}
          && c \sum_{n=0}^\infty \left[
             \E_{-\xi(2s - 1)} f_{2,n}(u,\xi)
             \right]^{1/2s\xi} \\
          &\leq& c_1 \sum_{n=0}^\infty \sum_{k=n}^{n+N-1} p^{k-2} q^{2} +
                 c \sum_{n=0}^{\infty} \sum_{k=n+N}^\infty a^{k-n} p^{k-2}
                 q^{n-k+2} \\
          &=& c_1 p^{-2} q^2 {1 - p^N \over (1-p)^2 }
              + \sum_{n=0}^{\infty} a^{-n} p^{-2} q^{n+2} \sum_{k=n+N}^{\infty}
              \left({ap \over q}\right)^k
        \end{eqnarray*}
        Choose $a > 1$ such that $ap < q$. Then
        \begin{eqnarray*}
          && \sum_{n=0}^{\infty} a^{-n} p^{-2} q^{n+2} \sum_{k=n+N}^{\infty}
             \left({ap \over q}\right)^k \\
          &=& \frac{
              a^N p^{N-2} q^{2-N}
              }{
              1 - ap/q
              } {1 \over 1 - p}
        \end{eqnarray*}
        Thus
        \[
        \sum_{n=0}^\infty \left[
          \E_{-\xi(2s - 1)} f_{2,n}(u,\xi)
        \right]^{1/2s\xi} < \infty  
        \]

      \item if $s \leq 1/2\xi$, $(\cdot)^{1/2s\xi}$ is a convex
        functon. We note that, if $s$ is chosen from $({1 \over 2\xi} -
        {\epsilon - 1 \over 2}, {1 \over 2\xi}]$, then $1 - \xi(2s - 1) < \xi
        \epsilon$, and it follows $\E_{-\xi(2s - 1)} \|A\| < \infty$
        and $\E_{-\xi(2s - 1)} |B| < \infty$. Jensen's inequality gives
        \begin{eqnarray*}
          && [\E_{-\xi(2s - 1)} f_{2,n}(u,\xi)]^{1/2s\xi} \\
          &\leq& \E_{-\xi(2s - 1)} \left[ f_{2,n}(u,\xi)^{1/2s\xi} \right]\\
          &\leq& \sum_{k=n}^\infty
          \E_{-\xi(2s - 1)}\|A_k \cdots A_{n+1}\|
          \E_{-\xi(2s - 1)}|B_n| \times \\
          && \lambda(-\xi(2s - 1))^{k/2s\xi} \1{T_u < \tau}
          \P_{-\xi(2s - 1)}(T_u \geq k)
        \end{eqnarray*}
      \end{enumerate}

    \item Secondly, we show $f_1(u) < \infty$.
      \begin{eqnarray*}
        && \E_D N_u^{2r} \1{T_u < \tau} \\
        &=& \E \left[
          N_u^{2r} |A_{T_u} \cdots A_1 X_0|^{\xi}
          \frac{r(X_{T_u}; \xi)}{r(X_0; \xi)}
          \1{T_u < \tau}
        \right]
      \end{eqnarray*}
      H\"older's inequality gives
      \begin{eqnarray*}
        && \E_D N_u^{2r} \1{T_u < \tau} \\
        &\leq& (\E N_u^{2rt})^{1/t}
        (\E |A_{T_u} \cdots A_1 X_0|^{s\xi} \1{T_u < \tau})^{1/s}
      \end{eqnarray*}
      where $1/s + 1/t = 1$.
      \begin{eqnarray*}
        && \E N_u^{2rt} \leq \E \tau^{2rt} \leq 1 + \sum_{n=2}^\infty
        n^{2rt} \P(\tau > n-1)
      \end{eqnarray*}
      Applying \eqref{eq:ret_time} with $\beta=0$ yields
      \[
      \P(\tau > n-1) \leq K \lambda(\alpha)^{n-2}
      \]
      where $\alpha > 0$ is chosen such that $\lambda(\alpha) < 1$. Thus
      \begin{eqnarray*}
        && \sum_{n=2}^\infty n^{2rt} \P(\tau > n-1) \leq K \sum_{n=2}^\infty n^{2rt}
        \lambda(\alpha)^{n-2} < \infty
      \end{eqnarray*}
      
      As for the term $\E(|A_{T_u} \cdots A_1 X_0|^{s\xi} \1{T_u <
        \tau})$, we have
      \begin{eqnarray*}
        && \E(|A_{T_u} \cdots A_1 X_0|^{s\xi} \1{T_u < \tau}) \\
        &\leq& \sum_{n=1}^{\infty} \E(\|A_n \cdots A_1 \|^{s\xi})
        \1{T_u < \tau} \P(T_u = n)
      \end{eqnarray*}
      As has been argued earlier, $\forall a > 1$, $\exists N \geq 1$
      such that $\forall n \geq N$, $\E\|A_n \cdots A_1\|^{s\xi} \leq
      [a \lambda(s\xi)]^{n}$. Therefore
      \begin{eqnarray*}
        && \sum_{n=1}^{\infty} \E(\|A_n \cdots A_1 \|^{s\xi})
        \1{T_u < \tau} \P(T_u = n) \\
        &\leq& c + \sum_{n=N}^\infty [a \lambda(s\xi)]^{n}
        \P(\tau > n-1)
      \end{eqnarray*}
      Now apply \eqref{eq:ret_time} with $\beta = 0$ and an $\alpha$
      that satisfies $\lambda(\alpha) < 1/a\lambda(s\xi)$. Such a choice
      of $\alpha$ is possible because $s > 1$ can be chosen
      as close to 1 as is necessary to make $\lambda(s\xi) > 1$ as close
      to 1 as is desired, while $\inf_{\alpha > 0} \lambda(\alpha) <
      1$.

      With $a, s, \alpha$ appropriately chosen,
      \begin{eqnarray*}
        && \sum_{n=1}^{\infty} \E(\|A_n \cdots A_1 \|^{s\xi})
        \1{T_u < \tau} \P(\tau > n-1) \\
        &\leq& c + K \lambda(\alpha)^{-2}\sum_{n=N}^\infty
        [a\lambda(s\xi) \lambda(\alpha)]^{n} < \infty
      \end{eqnarray*}
    \end{enumerate}
    Now that $f_1(u) < \infty$, $f_2(u, \xi) < \infty$,
    \[
    f(\xi) \leq c \limsup_{u \to \infty} f_1(u) f_2(u, \xi) < \infty.
    \]
  \item 
  \end{enumerate}
\end{proof}


\bibliographystyle{unsrt}
\bibliography{../../thesis/econophysics}
\end{document}
